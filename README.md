# äº¤é€šæ¨¡æ‹Ÿå™¨
æ±½è½¦çš„è¡Œé©¶ä»¥åŠç­‰çº¢ç»¿ç¯çš„åœºæ™¯è¿›è¡Œæ¨¡æ‹Ÿï¼Œä½¿ç”¨äº†`pixi`å’Œ`webgl`å»å®ç°çš„ã€‚  
webglä¸»è¦æ˜¯ç”¨åœ¨pixiä¸­spiteçš„`ç€è‰²å™¨`çš„ç¼–å†™ã€‚

# é¢„è§ˆ
[githubé¢„è§ˆåœ°å€](https://deardreamweb.github.io/traffic_simulator.github.io/)  
[giteeé¢„è§ˆåœ°å€](https://flyingwxb.gitee.io/traffic_simulator.gitee.io)  
ç½‘é€Ÿæ…¢çš„æ…¢çš„è¯å»ºè®®`giteeé¢„è§ˆåœ°å€`ï¼Œæ•ˆæœä¼šæ›´å¥½

# ç•Œé¢
![åŠŸèƒ½](https://resource.blogwxb.cn/traffic_simulator/QQ20221020-215230.gif)
# åŠŸèƒ½
![åŠŸèƒ½æ ‡æ³¨](https://resource.blogwxb.cn/traffic_simulator/screenshot_2.png)
ğŸ‘‰ğŸ»å³ä¾§åŒºåŸŸï¼š 
- å¯ä»¥çœ‹åˆ°å½“å‰çš„å¸§ç‡
- æš‚åœæŒ‰é’®å¯ä»¥è®©åŠ¨ç”»æš‚åœï¼Œå†æ¬¡ç‚¹å‡»å³å¯ç»§ç»­åŠ¨ç”»
  
ğŸ‘ˆğŸ»å·¦ä¾§åŒºåŸŸï¼š
æ±½è½¦çš„æ¨¡å¼ç›®å‰æ˜¯æœ‰å››ç§ï¼š`åŸå§‹æ¨¡å¼`ã€`å¤šå½©æ¨¡å¼`ã€`å¤šå½©é—ªå…‰æ¨¡å¼`ã€`ç®€ç¬”ç”»æ¨¡å¼`ã€‚  
- `å¤šå½©æ¨¡å¼`æ˜¯å¯ä»¥è®©åŸå§‹çš„æ±½è½¦é¢œè‰²è¿›è¡Œæ›´æ¢å¤šç§é¢œè‰²çš„æ›´æ¢
- `å¤šå½©é—ªå…‰æ¨¡å¼`æ˜¯è®©æ±½è½¦é¢œè‰²ä¸€ç›´éšæœºå˜
- `ç®€ç¬”ç”»æ¨¡å¼`æ˜¯è®©æ±½è½¦æ˜¯ç®€ç¬”ç”»çš„å½¢æ€
è¿™ä¸‰éƒ¨åˆ†æ˜¯é€šè¿‡`pixi`çš„`sprite`ç”¨çš„`webgl`æ¥å†™äº†ä¸€éƒ¨åˆ†`sharder`å®Œæˆçš„ã€‚

ğŸš—è½¦è¾†ç®¡ç†åŒºåŸŸï¼š  
ç›®å‰å°±ä¸¤æ¬¾è½¦å‹ï¼Œå¯ä»¥æ§åˆ¶é“è·¯ä¸Šè¡Œé©¶çš„è½¦è¾†ç±»å‹ï¼Œ`ç¦ç”¨`å¯ä»¥è®©è¯¥ç±»å‹çš„è½¦è¾†ä¸åœ¨é“è·¯ä¸Šè¡Œé©¶ï¼Œ`å¯ç”¨`åˆ™æ˜¯ç›¸åï¼Œå…è®¸è¯¥è½¦è¾†è¡Œé©¶ã€‚

# æŠ€æœ¯å®ç°
é¦–å…ˆè½¦è¾†çš„è¡Œé©¶æ–¹å‘æ˜¯ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘ï¼Œè¿™å››ä¸ªæ–¹å‘çš„è½¦è¾†æˆ‘è¿™é‡Œæ˜¯é‡‡ç”¨äº†`é“¾è¡¨`çš„æ•°æ®ç»“æ„ã€‚  
ä¸ºä»€ä¹ˆè¦ä½¿ç”¨é“¾è¡¨è¿™ç§æ•°æ®ç»“æ„å‘¢ï¼Ÿ  
å›ç­”ï¼šè€å­ä¹æ„ï¼ï¼ï¼    
å…¶å®æ˜¯å¹³æ—¶åªæœ‰åˆ·ç®—æ³•é¢˜çš„æ—¶å€™æ‰ç”¨åˆ°é“¾è¡¨ï¼Œå¹³æ—¶å·¥ä½œç”¨ä¸åˆ°ï¼Œæ‰€ä»¥å°±æƒ³ç”¨ç”¨é“¾è¡¨æ¥å®ç°ã€‚å½“ç„¶ç”¨`æ•°ç»„ä¹Ÿèƒ½å®ç°`ã€‚ç”±äºè½¦è¾†è¦ä¸æ–­åœ°åˆ é™¤æ·»åŠ çš„æ“ä½œæ‰€ä»¥é“¾è¡¨çš„æ•ˆç‡ä¼šæ›´é«˜ä¸€äº›ã€‚è¿™ä¸ªé¡¹ç›®ä¸­ç”¨åˆ°çš„é“¾è¡¨ä¹ŸæŒºä¸éš¾ï¼Œå°±æ˜¯é“¾è¡¨çš„æ·»åŠ å’Œåˆ é™¤ï¼Œä¼šè¿™ä¸¤ä¸ªå°±èƒ½è¿›è¡Œè½¦è¾†çš„æ·»åŠ å’Œåˆ é™¤ã€‚

## è½¦è¾†æ·»åŠ 
è½¦è¾†æ˜¯`pixijs`çš„`sprite`ï¼Œæ¯ç§ç±»å‹çš„è½¦è¾†éƒ½æ˜¯åˆ†ä¸º`ä¸Šä¸‹å·¦å³`å››å¼ å›¾ç‰‡ã€‚

![æœªå‘½å.png](https://resource.blogwxb.cn/traffic_simulator/screenshot_3.png)

æ·»åŠ è½¦è¾†å°±æ˜¯åœ¨é“¾è¡¨çš„æœ€åæ·»åŠ ä¸Šspriteï¼Œå­˜å‚¨æ•°æ®æ˜¯ `carData`ï¼Œå®ƒæ˜¯ä¸ªuseRefã€‚æ˜¯åˆ†ä¸º`left right top bottom`å››ä¸ªå­—æ®µï¼Œä»£è¡¨å››ä¸ªæ–¹å‘ï¼Œæ¯ä¸ªå­—æ®µéƒ½æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ˜¯æ¯ä¸ªæ–¹å‘çš„è½¦è¾†ã€‚æ ¹æ®æ¯ä¸ªæ–¹å‘è¦å¯¹sprite è¿›è¡Œxï¼Œyç‚¹è¿›è¡Œåˆå§‹åŒ–ï¼Œæ ¹æ®å‰ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹çš„xå’Œyï¼Œè®¡ç®—æ·»åŠ è½¦è¾†çš„xå’Œyã€‚
```js
// direction ï¼š æ–¹å‘  WIDTH ç”»å¸ƒçš„å®½åº¦ HEIGHT ç”»å¸ƒçš„é«˜åº¦  ROADWIDTH é“è·¯çš„å®½åº¦
// è¯¥é“¾è¡¨å¦‚æœå­˜åœ¨èŠ‚ç‚¹æœ€åæ·»åŠ èŠ‚ç‚¹ï¼Œæ²¡æœ‰èŠ‚ç‚¹ç›´æ¥æ”¾å…¥
if (carData.current[direction]) {
  let current = carData.current[direction]!;
  // æ‹¿åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹
  while (current.next) {
    current = current.next!;
  }
  // æ ¹æ®æœ€åä¸€ä¸ªèŠ‚ç‚¹è®¡ç®—å‡ºè¦æ·»åŠ èŠ‚ç‚¹çš„ä½ç½®
  switch (direction) {
    case 'left':
      sprite.y = (HEIGHT - ROADWIDTH) / 2 + ROADWIDTH / 4;
      if (current.val.x >= WIDTH - CARLENGTH / 2) {
        sprite.x = current.val.x + CARLENGTH * 1.5;
      } else {
        sprite.x = WIDTH - CARLENGTH / 2;
      }
      break;
    case 'right':
      sprite.y = HEIGHT / 2 + ROADWIDTH / 4;
      if (current.val.x <= -CARLENGTH / 2) {
        sprite.x = current.val.x - CARLENGTH * 1.5;
      } else {
        sprite.x = -CARLENGTH / 2;
      }
      break;
    case 'top':
      sprite.x = WIDTH / 2 + ROADWIDTH / 4;
      if (current.val.y >= HEIGHT + CARLENGTH / 2) {
        sprite.y = current.val.y + CARLENGTH * 1.5;
      } else {
        sprite.y = HEIGHT + CARLENGTH / 2;
      }
      break;
    case 'bottom':
      sprite.x = WIDTH / 2 - ROADWIDTH / 4;
      if (current.val.y <= -CARLENGTH / 2) {
        sprite.y = current.val.y - CARLENGTH * 1.5;
      } else {
        sprite.y = -CARLENGTH / 2;
      }
      break;
  }
  current.next = new ListNode(sprite);
} else {
  if (direction === 'left') { // å‘å·¦è¡Œé©¶çš„è½¦è¾†ä½ç½®
    sprite.y = (HEIGHT - ROADWIDTH) / 2 + ROADWIDTH / 4;
    sprite.x = WIDTH - CARLENGTH / 2;
  } else if (direction === 'right') { // å‘å³è¡Œé©¶çš„è½¦è¾†ä½ç½®
    sprite.y = HEIGHT / 2 + ROADWIDTH / 4;
    sprite.x = -CARLENGTH / 2;
  } else if (direction === 'top') {  // å‘ä¸Šè¡Œé©¶çš„è½¦è¾†ä½ç½®
    sprite.x = WIDTH / 2 + ROADWIDTH / 4;
    sprite.y = HEIGHT + CARLENGTH / 2;
  } else if (direction === 'bottom') {  // å‘ä¸‹è¡Œé©¶çš„è½¦è¾†ä½ç½®
    sprite.x = WIDTH / 2 - ROADWIDTH / 4;
    sprite.y = -CARLENGTH / 2;
  }
  carData.current[direction] = new ListNode(sprite);
}
```
## è½¦è¾†è¡Œé©¶
è½¦è¾†è¡Œé©¶éœ€è¦è€ƒè™‘å‡ ç‚¹ï¼š
- å½“å‰é¢çº¢ç¯æ€ä¹ˆåŠï¼Ÿ
- åé¢çš„è½¦è¾†è¦æ’åˆ°å‰ä¸€ä¸ªè½¦è¾†æ€ä¹ˆåŠï¼Ÿ
- ä¸ºäº†çµæ´»æ€§ï¼Œæ±½è½¦ä»€ä¹ˆæ—¶å€™åŠ é€Ÿï¼Œä»€ä¹ˆæ—¶å€™å‡é€Ÿï¼Ÿ  

ä¸‹é¢ä¸€ä¸€è§£ç­”ï¼š
- å½“ä¸ºçº¢ç¯çš„æ—¶å€™ï¼Œä¸‹ä¸€æ­¥å°±è¦é—¯çº¢ç¯äº†ï¼Œè¿™æ—¶éœ€è¦è®©è½¦è¾†åœæ­¢ï¼Œä½ç½®ä¸€ç›´ä¿æŒä¸ºåŸæ¥çš„ä½ç½®
- åé¢çš„è½¦è¦æ’åˆ°å‰é¢çš„è½¦ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼šä¸€ç§æ˜¯å‰é¢çš„è½¦åœ¨ç­‰çº¢ç»¿ç¯ï¼Œå¦ä¸€ç§æ˜¯éƒ½æ˜¯è¡Œé©¶çŠ¶æ€ï¼Œåé¢è½¦çš„è½¦é€Ÿå¤§äºå‰é¢è½¦çš„è½¦é€Ÿã€‚è¿™æ—¶å€™éœ€è¦è®¾ç½®ä¸€ä¸ª`é˜ˆå€¼ min`ï¼Œå½“åè½¦ä¸å‰è½¦çš„è·ç¦»å°äºè¿™ä¸ª`min`çš„æ—¶å€™ï¼Œéœ€è¦è®©åè½¦ç›¸å¯¹äºå‰è½¦é€Ÿåº¦è¿›è¡Œå‡é€Ÿï¼Œå¦‚æœå‡é€Ÿè¿˜æ˜¯ä¼šå°äºè¿™ä¸ª`min`çš„è¯ï¼Œè¯´æ˜å‰è½¦åœ¨ç­‰çº¢ç»¿ç¯ï¼Œè¿™æ—¶å€™åè½¦çš„ä½ç½®ç­‰äºè¿™ä¸ª`min`å°±è¡Œäº†ï¼Œä¿è¯ä¸å°äºè¿™ä¸ª`min`ã€‚
- ä¸Šé¢è¯´è®¾ç½®ä¸€ä¸ªè½¦è·ä¹‹é—´çš„æœ€å°`é˜ˆå€¼ min`ï¼Œæ˜¯ä¸ºäº†è®©è½¦å‡é€Ÿï¼ŒåŠ é€Ÿåˆ™æ˜¯è¦è®¾ç½®è½¦è·ä¹‹é—´çš„æœ€å¤§`é˜ˆå€¼ max`ï¼Œè½¦è·è¶…è¿‡è¿™ä¸ª`max`å°±è¿›è¡ŒåŠ é€Ÿæ“ä½œã€‚  
ä»£ç å°±ä¸å±•ç¤ºäº†ï¼Œä¸»è¦æ˜¯é“¾è¡¨çš„éå†å»å¯¹æ¯è¾†è½¦è¿›è¡Œè®¡ç®—ã€‚

## è½¦è¾†æ¨¡å¼
å› ä¸º`pixijs`é»˜è®¤æ˜¯ä½¿ç”¨`webgl`å»è¿›è¡Œæ¸²æŸ“çš„ï¼Œ`sprite`æ˜¯`æ”¯æŒä½¿ç”¨webglç¼–å†™ç€è‰²å™¨çš„`ã€‚æ ¹æ®é€‰æ‹©çš„ä¸åŒæ¨¡å¼è¿›è¡Œç€è‰²å™¨sharderçš„ç¼–å†™å®Œæˆçš„ã€‚  

`å¤šå½©æ¨¡å¼`ï¼šç”Ÿæˆä¸€ä¸ª`éšæœºçš„rgb`ä¸‰ä¸ªé€šé“çš„å€¼ï¼Œç„¶ååˆ°é€šè¿‡`uniform`ä¼ å…¥åˆ°ç‰‡å…ƒç€è‰²å™¨ä¸å½“å‰çš„è‰²å€¼è¿›è¡Œ`ç›¸ä¹˜`ï¼Œæ·±è‰²éƒ¨åˆ†æ‰“ç®—æ˜¯ä¿ç•™ä¸‹æ¥çš„ï¼Œæ‰€ä»¥è®¾ç½®ä¸€ä¸ª`é˜ˆå€¼`ï¼Œè¶…è¿‡è¿™ä¸ªé˜ˆå€¼ä»£è¡¨`æµ…è‰²`ï¼Œæµ…è‰²éƒ¨åˆ†ä¼šå»è·Ÿéšæœºrgbè¿›è¡Œç›¸ä¹˜ã€‚

`å¤šå½©é—ªå…‰æ¨¡å¼`ï¼šå’Œå¤šå½©æ¨¡å¼å®ç°æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«æ˜¯åŠ¨ç”»æ¯å¸§éƒ½ä¼šä½¿ç”¨å¤šå½©ï¼Œæ‰€ä»¥æœ‰äº†å¤šå½©é—ªå…‰çš„ä¸€ä¸ªæ•ˆæœã€‚

`ç®€ç¬”ç”»æ¨¡å¼`ï¼šè¿™ä¸ªæ˜¯æˆ‘å†™å¤šå½©æ¨¡å¼çš„sharderæ— æ„é—´å®ç°å‡ºæ¥çš„ï¼ŒåŸç†ä¹Ÿæ˜¯å¾ˆç®€å•çš„ï¼Œå°†æµ…è‰²éƒ¨åˆ†éƒ½å˜æˆç™½è‰²ï¼Œåªç•™ä¸‹æ·±è‰²éƒ¨åˆ†ï¼Œå°±æ˜¯ç®€ç¬”ç”»çš„æ•ˆæœã€‚

```js
/**
 * æ±½è½¦é¢œè‰²æ»¤é•œ
 * @param sprite
 */
export const carFilterColor = (sprite: Sprite, type?: number) => {
  const fragStr = `
    varying vec2 vTextureCoord;
    uniform sampler2D uSampler;
    uniform vec2 size;
    uniform vec3 secondaryColor;
    uniform float type;
    
    void main(void){
      vec2 uv = size;
      vec4 color = texture2D(uSampler, vTextureCoord);
      // é˜ˆå€¼
      float num = 0.3;
      if(type != 0.0){
        if(color.r > num || color.g  >= num || color.b >= num){
            if(type == 1.0 || type == 2.0 ){ / å¤šå½©æˆ–å¤šå½©é—ªå…‰æ¨¡å¼
                color.rgb *= secondaryColor;
            }else if (type == 3.0){  // ç®€ç¬”ç”»æ¨¡å¼
                color.rgb = vec3(1.0);
            }
        }
        color.rgb = clamp(vec3(0.0),color.rgb,vec3(1.0));
      }
      gl_FragColor = color;
    }
  `;
  let filter = new PIXI.Filter(undefined, fragStr, {
    secondaryColor: [
      Math.random() + 0.6,
      Math.random() + 0.6,
      Math.random() + 0.6,
    ],
    type: type || 0,
  });
  sprite.filters = [filter];
};
```


è¿˜æœ‰ä¸€äº›ç»†èŠ‚ç‚¹å°±ä¸ä¸€ä¸€èµ˜è¿°äº†ï¼Œå¦‚ï¼šäº¤é€šç¯çš„è®¾è®¡å’Œæ§åˆ¶ã€è½¦è¾†ç±»å‹çš„æ§åˆ¶ç­‰ç­‰ã€‚

å¦‚æœæ„Ÿè§‰ä¸é”™çš„è¯ï¼Œç»™starâ­ï¸